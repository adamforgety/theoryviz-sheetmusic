<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TheoryViz</title>
  <meta name="theme-color" content="#3b82f6" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vexflow/releases/vexflow-min.js"></script>
  <style>
    .keyboard-container {
      position: relative;
      height: 250px;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      background-color: #f3f4f6;
      overflow-x: scroll;
      overscroll-behavior: contain;
    }
    .keyboard-container::-webkit-scrollbar {
      display: none;
    }
    .keyboard-container {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .highlight-transition {
      transition: fill 0.2s ease;
    }
    .viz-btn {
      border-radius: 0.5rem;
      transition: all 0.2s;
      font-weight: 600;
      padding-top: 0.625rem;
      padding-bottom: 0.625rem;
      border-width: 1px;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-3 text-center">TheoryViz</h1>
    <p class="text-center text-gray-600 mb-6">Visualize harmony anywhere!</p>

    <!-- Control Panel -->
    <div class="p-4 bg-gray-100 rounded-xl mb-6 shadow-inner border border-gray-200">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="key-select" class="block text-xs font-medium text-gray-700 mb-1">Root Key</label>
          <select id="key-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 text-sm"></select>
        </div>
        <div>
          <label for="mode-select" class="block text-xs font-medium text-gray-700 mb-1">Scale Type</label>
          <select id="mode-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 text-sm"></select>
        </div>
        <button id="mode-chord-btn" class="viz-btn w-full text-sm md:text-base">Chord View</button>
        <button id="mode-scale-btn" class="viz-btn w-full text-sm md:text-base">Scale View</button>
      </div>
    </div>

    <!-- Display -->
    <div id="consolidated-display" class="mb-4 py-3 px-4 bg-blue-50 text-blue-800 rounded-lg shadow-inner border border-blue-200 text-center"></div>

    <!-- Piano Keyboard -->
    <div id="piano-container" class="keyboard-container overflow-x-scroll pb-4 mt-4">
      <svg id="piano-keyboard-svg" width="100%" height="200"></svg>
    </div>

    <!-- Sheet Music Viewer -->
    <div id="sheet-music-container" class="mt-6 p-4 bg-white rounded-lg shadow-md">
      <h2 class="text-lg font-bold text-gray-700 mb-2">Sheet Music View</h2>
      <div id="sheet-music-renderer"></div>
    </div>
  </div>
Awesome, Adam â€” hereâ€™s **Part 2** of your complete TheoryViz + Sheet Music Viewer app. This includes all the JavaScript logic: state management, keyboard rendering, scale/chord selection, inversion handling, and the new sheet music rendering with VexFlow.

---

### ðŸ“¦ Part 2: JavaScript Logic (Place inside `<script>` tags at the end of your HTML)

```html
<script>
  const KEYS = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  const MAJOR_INTERVALS = [0, 2, 4, 5, 7, 9, 11];
  const SCALE_MODES = {
    major: {
      name: "Ionian (Major)",
      intervals: [0, 2, 4, 5, 7, 9, 11],
      chordSteps: [0, 2, 4],
      isDiatonic: true
    }
  };
  const START_MIDI = 60;
  const END_MIDI = 84;

  const state = {
    currentKeyIndex: 0,
    currentModeId: "major",
    currentDegree: 1,
    currentInversion: 0,
    highlightedMidiNotes: [],
    visualizationMode: "chord"
  };

  function midiToVexflowNote(midi) {
    const noteNames = ["c", "c#", "d", "d#", "e", "f", "f#", "g", "g#", "a", "a#", "b"];
    const pitchClass = midi % 12;
    const octave = Math.floor(midi / 12) - 1;
    return noteNames[pitchClass] + "/" + octave;
  }

  function renderSheetMusic(midiNotes) {
    const VF = Vex.Flow;
    const container = document.getElementById("sheet-music-renderer");
    container.innerHTML = "";

    const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
    renderer.resize(500, 200);
    const context = renderer.getContext();
    const stave = new VF.Stave(10, 40, 400);
    stave.addClef("treble").setContext(context).draw();

    const keys = midiNotes.map(midi => midiToVexflowNote(midi));
    const duration = midiNotes.length > 1 ? "q" : "w";
    const note = new VF.StaveNote({ clef: "treble", keys, duration });

    keys.forEach((key, i) => {
      if (key.includes("#")) {
        note.addAccidental(i, new VF.Accidental("#"));
      }
    });

    const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
    voice.addTickables([note]);
    new VF.Formatter().joinVoices([voice]).format([voice], 350);
    voice.draw(context, stave);
  }

  function calculateChordMidiNotes(keyIndex, degree, inversion) {
    const mode = SCALE_MODES[state.currentModeId];
    const scaleIntervals = mode.intervals;
    const scaleDegreeIndex = degree - 1;
    const tonicMidi = 60 + keyIndex;
    const rootInterval = scaleIntervals[scaleDegreeIndex];
    const rootMidi = tonicMidi + rootInterval;

    const thirdIndex = (scaleDegreeIndex + mode.chordSteps[1]) % scaleIntervals.length;
    const fifthIndex = (scaleDegreeIndex + mode.chordSteps[2]) % scaleIntervals.length;

    let thirdOffset = scaleIntervals[thirdIndex] - scaleIntervals[scaleDegreeIndex];
    if (thirdOffset < 0) thirdOffset += 12;
    let fifthOffset = scaleIntervals[fifthIndex] - scaleIntervals[scaleDegreeIndex];
    if (fifthOffset < 0) fifthOffset += 12;

    let chord = [rootMidi, rootMidi + thirdOffset, rootMidi + fifthOffset];
    for (let i = 0; i < inversion; i++) {
      const note = chord.shift();
      chord.push(note + 12);
    }
    return chord.filter(midi => midi >= START_MIDI && midi <= END_MIDI);
  }

  function drawKeyboard() {
    const svg = document.getElementById("piano-keyboard-svg");
    svg.innerHTML = "";
    const highlighted = state.highlightedMidiNotes;

    for (let midi = START_MIDI; midi <= END_MIDI; midi++) {
      const pitchClass = midi % 12;
      const isWhite = MAJOR_INTERVALS.includes(pitchClass);
      const x = (midi - START_MIDI) * 30;
      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute("x", x);
      rect.setAttribute("y", 10);
      rect.setAttribute("width", 28);
      rect.setAttribute("height", isWhite ? 180 : 110);
      rect.setAttribute("fill", highlighted.includes(midi) ? "#3b82f6" : isWhite ? "#fff" : "#1f2937");
      rect.setAttribute("stroke", "#000");
      svg.appendChild(rect);
    }

    renderSheetMusic(state.highlightedMidiNotes);
  }

  function updateVisualization() {
    state.highlightedMidiNotes = calculateChordMidiNotes(state.currentKeyIndex, state.currentDegree, state.currentInversion);
    drawKeyboard();
  }

  function populateSelectors() {
    const keySelect = document.getElementById("key-select");
    KEYS.forEach((key, i) => {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = key;
      keySelect.appendChild(option);
    });
    keySelect.value = state.currentKeyIndex;
    keySelect.addEventListener("change", e => {
      state.currentKeyIndex = parseInt(e.target.value);
      updateVisualization();
    });

    const modeSelect = document.getElementById("mode-select");
    Object.entries(SCALE_MODES).forEach(([id, mode]) => {
      const option = document.createElement("option");
      option.value = id;
      option.textContent = mode.name;
      modeSelect.appendChild(option);
    });
    modeSelect.value = state.currentModeId;
    modeSelect.addEventListener("change", e => {
      state.currentModeId = e.target.value;
      updateVisualization();
    });

    document.getElementById("mode-chord-btn").addEventListener("click", () => {
      state.visualizationMode = "chord";
      updateVisualization();
    });

    document.getElementById("mode-scale-btn").addEventListener("click", () => {
      state.visualizationMode = "scale";
      updateVisualization();
    });
  }

  populateSelectors();
  updateVisualization();
</script>
</body>
</html>
